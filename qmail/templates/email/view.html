{% extends "base.html" %}

{% block title %}{{ email.subject or '(No Subject)' }} - QMail{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="mb-3 d-flex justify-content-between align-items-center">
        <div>
            <a href="{{ url_for('email.inbox') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Inbox
            </a>
            <a href="{{ url_for('email.delete', email_id=email.id) }}" class="btn btn-outline-danger" 
               onclick="return confirm('Are you sure you want to delete this email?')">
                <i class="fas fa-trash"></i> Delete
            </a>
        </div>
        
        <!-- Email Actions -->
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-warning {% if email.is_starred %}active{% endif %}" 
                    onclick="toggleStar({{ email.id }})" id="star-btn">
                <i class="fas fa-star"></i> {% if email.is_starred %}Starred{% else %}Star{% endif %}
            </button>
            <button type="button" class="btn btn-outline-danger {% if email.is_important %}active{% endif %}" 
                    onclick="toggleImportant({{ email.id }})" id="important-btn">
                <i class="fas fa-exclamation-circle"></i> {% if email.is_important %}Important{% else %}Mark Important{% endif %}
            </button>
            {% if not email.is_spam %}
            <button type="button" class="btn btn-outline-secondary" 
                    onclick="markAsSpam({{ email.id }})">
                <i class="fas fa-ban"></i> Report Spam
            </button>
            {% else %}
            <button type="button" class="btn btn-outline-success" 
                    onclick="notSpam({{ email.id }})">
                <i class="fas fa-check"></i> Not Spam
            </button>
            {% endif %}
        </div>
    </div>
    
    {% if email.is_encrypted %}
    <!-- Security Warning Banner - REMOVED -->
    {% endif %}
    
    <div class="card">
        {% if email.is_encrypted %}
        <!-- Secure Email Header -->
        <div class="secure-email-header">
            <div class="header-left">
                <div class="shield-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="header-info">
                    <h3>{{ email.subject or '(No Subject)' }}</h3>
                    <p>Protected with {{ email.security_level_name or 'Quantum' }} Encryption</p>
                </div>
            </div>
            <div class="security-level level-{{ email.security_level or 2 }}">
                <i class="fas fa-lock"></i>
                {{ email.security_level_name or 'ENCRYPTED' }}
            </div>
        </div>
        {% else %}
        <div class="card-header">
            <h4 class="mb-0">
                {{ email.subject or '(No Subject)' }}
            </h4>
        </div>
        {% endif %}
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-12">
                    <p class="mb-1"><strong>From:</strong> {{ email.from_addr }}</p>
                    <p class="mb-1"><strong>To:</strong> {{ email.to_addr }}</p>
                    {% if email.cc_addr %}
                    <p class="mb-1"><strong>CC:</strong> {{ email.cc_addr }}</p>
                    {% endif %}
                    <p class="mb-1">
                        <strong>Date:</strong> 
                        {% if email.received_at %}
                        {{ email.received_at.strftime('%Y-%m-%d %H:%M:%S') }}
                        {% elif email.sent_at %}
                        {{ email.sent_at.strftime('%Y-%m-%d %H:%M:%S') }}
                        {% endif %}
                    </p>
                    {% if email.is_encrypted %}
                    <p class="mb-1">
                        <strong>Security:</strong> 
                        <span class="badge bg-warning text-dark">
                            <i class="fas fa-shield-alt"></i> 
                            {{ email.security_level_name or 'Encrypted' }}
                        </span>
                    </p>
                    <p class="mb-1">
                        <strong>QKD Key ID:</strong> 
                        <code>{{ email.qkd_key_id or 'N/A' }}</code>
                    </p>
                    {% endif %}
                </div>
            </div>
            
            <hr>
            
            <!-- Attachments -->
            {% if email.attachments.count() > 0 %}
            <div class="attachments-section mb-3">
                <h6><i class="fas fa-paperclip"></i> Attachments ({{ email.attachments.count() }})</h6>
                
                <!-- Image Attachments (Display Inline) -->
                {% set image_attachments = [] %}
                {% set other_attachments = [] %}
                {% for attachment in email.attachments %}
                    {% if attachment.content_type and attachment.content_type.startswith('image/') %}
                        {% set _ = image_attachments.append(attachment) %}
                    {% else %}
                        {% set _ = other_attachments.append(attachment) %}
                    {% endif %}
                {% endfor %}
                
                {% if image_attachments %}
                <div class="image-attachments mb-3">
                    <h6 class="text-muted"><i class="fas fa-images"></i> Images</h6>
                    <div class="row g-3">
                        {% for attachment in image_attachments %}
                        <div class="col-md-4 col-sm-6">
                            <div class="card">
                                <img src="{{ url_for('email.view_attachment_inline', attachment_id=attachment.id) }}" 
                                     class="card-img-top attachment-image" 
                                     alt="{{ attachment.filename }}"
                                     loading="lazy"
                                     style="max-height: 300px; object-fit: contain; cursor: pointer;"
                                     onclick="openImageModal(this.src, '{{ attachment.filename }}')">
                                <div class="card-body p-2">
                                    <p class="card-text mb-1">
                                        <small class="text-muted">
                                            <strong>{{ attachment.filename }}</strong><br>
                                            {{ (attachment.original_size / 1024)|round(1) }} KB
                                            {% if attachment.is_encrypted %}
                                            | <i class="fas fa-lock text-warning"></i>
                                            {% endif %}
                                        </small>
                                    </p>
                                    <div class="btn-group btn-group-sm w-100" role="group">
                                        <a href="{{ url_for('email.download_attachment', attachment_id=attachment.id) }}" 
                                           class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-download"></i> Download
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Other Attachments (Files) -->
                {% if other_attachments %}
                <div class="other-attachments">
                    <h6 class="text-muted"><i class="fas fa-file"></i> Files</h6>
                    <div class="list-group">
                        {% for attachment in other_attachments %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-file"></i>
                                    <strong>{{ attachment.filename }}</strong>
                                    <br>
                                    <small class="text-muted">
                                        Size: {{ (attachment.original_size / 1024 / 1024)|round(2) }} MB
                                        {% if attachment.is_encrypted %}
                                        | <i class="fas fa-lock text-warning"></i> {{ attachment.security_level_name }}
                                        {% endif %}
                                    </small>
                                </div>
                                <div>
                                    <a href="{{ url_for('email.download_attachment', attachment_id=attachment.id) }}" 
                                       class="btn btn-sm btn-primary">
                                        <i class="fas fa-download"></i> Download
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            <hr>
            {% endif %}
            
            <div class="email-body">
                {% if email.is_encrypted %}
                    {% if decrypted_body %}
                        <!-- Encrypted Message with Reveal Animation -->
                        <div class="encrypted-message-container">
                            <div class="alert alert-warning mb-3 d-flex justify-content-between align-items-center" id="encrypted-banner">
                                <div>
                                    <i class="fas fa-lock"></i> 
                                    <strong>QMail Encrypted Message</strong> - Protected with {{ email.security_level_name or 'Quantum' }} Encryption
                                </div>
                                <div class="button-group">
                                    <button class="btn btn-sm btn-primary reveal-hide-btn" id="reveal-btn" onclick="revealMessage()">
                                        <span class="btn-icon"><i class="fas fa-eye"></i></span>
                                        <span class="btn-text">Reveal Message</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Floating Quick Hide Button (appears when content is revealed) -->
                            <button class="floating-hide-btn" id="floating-hide-btn" onclick="hideMessage()" style="display: none;">
                                <i class="fas fa-eye-slash"></i>
                                <span class="tooltip-text">Quick Hide</span>
                            </button>
                            
                            <!-- Hidden Decrypted Content (Secure Mode) -->
                            <div id="decrypted-content" class="decrypted-content secure-content" style="display: none;">
                                <div class="alert alert-success mb-3 decrypt-success-animation d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-unlock"></i> Message successfully decrypted using quantum key
                                    </div>
                                    <button class="btn btn-sm btn-danger hide-content-btn" onclick="hideMessage()">
                                        <i class="fas fa-eye-slash"></i> Hide Message
                                    </button>
                                </div>
                                {% if is_html_content %}
                                <div class="email-html-body message-reveal-animation">
                                    {{ decrypted_body|safe }}
                                </div>
                                {% else %}
                                <pre class="bg-light p-3 rounded message-reveal-animation">{{ decrypted_body }}</pre>
                                {% endif %}
                                
                                <!-- Bottom Hide Button -->
                                <div class="text-center mt-3">
                                    <button class="btn btn-danger hide-content-btn" onclick="hideMessage()">
                                        <i class="fas fa-eye-slash"></i> Hide Message
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% elif decryption_error %}
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> 
                            <strong>Decryption Failed:</strong> {{ decryption_error }}
                        </div>
                        <div class="alert alert-info">
                            <strong>Encrypted Content:</strong>
                            <pre class="mt-2">{{ email.body[:500] }}...</pre>
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-key"></i> 
                            This is an encrypted message. Attempting to decrypt...
                        </div>
                        <pre class="bg-light p-3 rounded">{{ email.body }}</pre>
                    {% endif %}
                {% else %}
                    {% if is_html_content %}
                    <div class="email-html-body">
                        {{ email.body|safe }}
                    </div>
                    {% else %}
                    <pre class="bg-light p-3 rounded">{{ email.body }}</pre>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">Image Viewer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" alt="" class="img-fluid" style="max-height: 80vh;">
            </div>
        </div>
    </div>
</div>

<script>
// Open image in modal
function openImageModal(src, filename) {
    const modal = new bootstrap.Modal(document.getElementById('imageModal'));
    document.getElementById('modalImage').src = src;
    document.getElementById('modalImage').alt = filename;
    document.getElementById('imageModalLabel').textContent = filename;
    modal.show();
}

// Lazy load images
document.addEventListener('DOMContentLoaded', function() {
    const images = document.querySelectorAll('.attachment-image');
    
    if ('IntersectionObserver' in window) {
        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.src = img.dataset.src || img.src;
                    img.classList.add('loaded');
                    observer.unobserve(img);
                }
            });
        });
        
        images.forEach(img => imageObserver.observe(img));
    }
});

// Auto-hide timer (DISABLED)
let autoHideTimer = null;
let countdownTimer = null;
const AUTO_HIDE_SECONDS = 0; // DISABLED - set to 0 to turn off auto-hide
const DEBUG_MODE = false; // Set to false to disable console logs

// Reveal encrypted message with animation
function revealMessage() {
    if (DEBUG_MODE) console.log('üîì Reveal message called');
    
    const banner = document.getElementById('encrypted-banner');
    const content = document.getElementById('decrypted-content');
    const revealBtn = document.getElementById('reveal-btn');
    
    // Clear any existing timers
    clearAutoHideTimer();
    
    if (DEBUG_MODE) console.log(`‚è±Ô∏è Starting auto-hide timer: ${AUTO_HIDE_SECONDS} seconds`);
    
    // Enable security mode for decrypted content
    if (window.qmailSecurity) {
        window.qmailSecurity.enableSecureMode('decrypted-content');
    }
    
    // Animate button transformation
    revealBtn.classList.add('btn-transforming');
    
    setTimeout(() => {
        // Change button to "hide" mode with animation
        revealBtn.innerHTML = '<span class="btn-icon"><i class="fas fa-eye-slash"></i></span><span class="btn-text">Hide Message</span>';
        revealBtn.onclick = hideMessage;
        revealBtn.classList.remove('btn-primary');
        revealBtn.classList.add('btn-danger');
        revealBtn.classList.remove('btn-transforming');
        revealBtn.classList.add('btn-transformed');
    }, 300);
    
    // Show floating hide button with animation
    const floatingBtn = document.getElementById('floating-hide-btn');
    if (DEBUG_MODE) console.log('üéà Showing floating button in 1 second...');
    setTimeout(() => {
        floatingBtn.style.display = 'flex';
        if (DEBUG_MODE) console.log('üéà Floating button display set to flex');
        setTimeout(() => {
            floatingBtn.classList.add('show');
            if (DEBUG_MODE) console.log('üéà Floating button class "show" added');
        }, 50);
    }, 1000);
    
    // Animate banner transformation
    banner.style.transition = 'all 0.5s ease';
    banner.classList.remove('alert-warning');
    banner.classList.add('alert-success');
    
    // Add decryption animation
    const lockIcon = banner.querySelector('.fas.fa-lock');
    if (lockIcon) {
        lockIcon.classList.add('unlock-animation');
        setTimeout(() => {
            lockIcon.classList.remove('fa-lock');
            lockIcon.classList.add('fa-unlock');
        }, 300);
    }
    
    // Update banner text
    setTimeout(() => {
        banner.querySelector('strong').textContent = 'Message Decrypted Successfully';
    }, 500);
    
    // Reveal content with cascading animation
    setTimeout(() => {
        content.style.display = 'block';
        content.classList.add('reveal-animation');
        
        // Trigger matrix-style reveal effect
        createMatrixEffect();
        
        // Auto-hide countdown DISABLED
        // startAutoHideCountdown(); // Commented out - no auto-hide
    }, 800);
}

// Start auto-hide countdown
function startAutoHideCountdown() {
    if (DEBUG_MODE) console.log('‚è∞ Countdown started');
    
    const banner = document.getElementById('encrypted-banner');
    let secondsLeft = AUTO_HIDE_SECONDS;
    
    // Create countdown display
    let countdownDisplay = banner.querySelector('.countdown-display');
    if (!countdownDisplay) {
        countdownDisplay = document.createElement('span');
        countdownDisplay.className = 'countdown-display';
        countdownDisplay.style.marginLeft = '10px';
        countdownDisplay.style.fontSize = '14px';
        countdownDisplay.style.opacity = '0.8';
        banner.querySelector('div').appendChild(countdownDisplay);
    }
    
    // Update countdown every second
    const updateCountdown = () => {
        if (secondsLeft > 0) {
            countdownDisplay.innerHTML = `<i class="fas fa-clock"></i> Auto-hiding in ${secondsLeft}s`;
            
            if (DEBUG_MODE && secondsLeft % 5 === 0) {
                console.log(`‚è±Ô∏è ${secondsLeft} seconds remaining`);
            }
            
            // Add warning class when time is running out (last 5 seconds)
            if (secondsLeft <= 5) {
                countdownDisplay.classList.add('countdown-warning');
                if (DEBUG_MODE && secondsLeft === 5) {
                    console.log('‚ö†Ô∏è Warning: 5 seconds left!');
                }
            }
            
            secondsLeft--;
        } else {
            countdownDisplay.innerHTML = '<i class="fas fa-lock"></i> Auto-hiding now...';
            if (DEBUG_MODE) console.log('‚è∞ Countdown reached 0!');
        }
    };
    
    // Initial update
    updateCountdown();
    
    // Update every second
    countdownTimer = setInterval(updateCountdown, 1000);
    
    // Set auto-hide timer
    autoHideTimer = setTimeout(() => {
        if (DEBUG_MODE) console.log('‚è∞ Auto-hide timer fired!');
        hideMessageWithAnimation();
    }, AUTO_HIDE_SECONDS * 1000);
    
    if (DEBUG_MODE) {
        console.log(`‚úÖ Auto-hide timer set for ${AUTO_HIDE_SECONDS} seconds`);
        console.log('Timer ID:', autoHideTimer);
    }
}

// Clear auto-hide timer
function clearAutoHideTimer() {
    if (autoHideTimer) {
        clearTimeout(autoHideTimer);
        autoHideTimer = null;
    }
    if (countdownTimer) {
        clearInterval(countdownTimer);
        countdownTimer = null;
    }
    
    // Remove countdown display
    const banner = document.getElementById('encrypted-banner');
    const countdownDisplay = banner?.querySelector('.countdown-display');
    if (countdownDisplay) {
        countdownDisplay.remove();
    }
}

// Hide message with special animation
function hideMessageWithAnimation() {
    if (DEBUG_MODE) console.log('üîí Auto-hide triggered!');
    
    const content = document.getElementById('decrypted-content');
    
    // Add pulsing fade effect
    content.style.animation = 'pulse-fade 1s ease-out';
    
    setTimeout(() => {
        hideMessage();
    }, 500);
}

function hideMessage() {
    console.log('üëÅÔ∏è Hide message called');
    
    // Get content element (this is the most important one)
    const content = document.getElementById('decrypted-content');
    
    if (!content) {
        console.error('‚ùå Content element not found!');
        alert('Error: Cannot find decrypted content element');
        return;
    }
    
    console.log('‚úÖ Content element found, hiding...');
    
    // Clear auto-hide timer
    clearAutoHideTimer();
    
    // Hide floating button with animation
    const floatingBtn = document.getElementById('floating-hide-btn');
    if (floatingBtn) {
        console.log('üéà Hiding floating button');
        floatingBtn.classList.remove('show');
        setTimeout(() => {
            floatingBtn.style.display = 'none';
        }, 300);
    }
    
    // Disable security mode
    if (window.qmailSecurity) {
        window.qmailSecurity.disableSecureMode('decrypted-content');
    }
    
    // Hide content with fade animation
    console.log('üîí Hiding content with animation');
    content.classList.remove('reveal-animation');
    content.classList.add('hide-animation');
    content.style.animation = '';
    
    setTimeout(() => {
        content.style.display = 'none';
        content.classList.remove('hide-animation');
        console.log('‚úÖ Content hidden!');
        
        // Ensure banner and its container are visible
        const banner = document.getElementById('encrypted-banner');
        if (banner) {
            banner.style.display = '';
            banner.style.visibility = 'visible';
            // Also ensure parent container is visible
            const container = banner.closest('.encrypted-message-container');
            if (container) {
                container.style.display = '';
                container.style.visibility = 'visible';
            }
            console.log('‚úÖ Banner and container visibility ensured');
        }
    }, 500);
    
    // Reset banner and button - IMPORTANT for revealing again
    const banner = document.getElementById('encrypted-banner');
    const revealBtn = document.getElementById('reveal-btn');
    
    if (banner) {
        console.log('üé® Resetting banner');
        banner.classList.remove('alert-success');
        banner.classList.add('alert-warning');
        
        const lockIcon = banner.querySelector('.fas.fa-unlock');
        if (lockIcon) {
            lockIcon.classList.remove('fa-unlock');
            lockIcon.classList.add('fa-lock');
            lockIcon.classList.remove('unlock-animation');
        }
        
        const strong = banner.querySelector('strong');
        if (strong) {
            strong.textContent = 'QMail Encrypted Message';
        }
    } else {
        console.warn('‚ö†Ô∏è Banner not found - using alternative method');
        // Try to find banner by class
        const bannerAlt = document.querySelector('.encrypted-message-container .alert');
        if (bannerAlt) {
            console.log('‚úÖ Found banner by class');
            bannerAlt.classList.remove('alert-success');
            bannerAlt.classList.add('alert-warning');
        }
    }
    
    if (revealBtn) {
        console.log('üîÑ Resetting reveal button');
        revealBtn.classList.add('btn-transforming');
        
        setTimeout(() => {
            revealBtn.innerHTML = '<span class="btn-icon"><i class="fas fa-eye"></i></span><span class="btn-text">Reveal Message</span>';
            revealBtn.onclick = revealMessage;
            revealBtn.classList.remove('btn-danger');
            revealBtn.classList.add('btn-primary');
            revealBtn.classList.remove('btn-transforming');
            revealBtn.classList.remove('btn-transformed');
            console.log('‚úÖ Reveal button reset complete');
        }, 300);
    } else {
        console.warn('‚ö†Ô∏è Reveal button not found - using alternative method');
        // Try to find button by class
        const btnAlt = document.querySelector('.reveal-hide-btn');
        if (btnAlt) {
            console.log('‚úÖ Found button by class');
            btnAlt.innerHTML = '<span class="btn-icon"><i class="fas fa-eye"></i></span><span class="btn-text">Reveal Message</span>';
            btnAlt.onclick = revealMessage;
            btnAlt.classList.remove('btn-danger');
            btnAlt.classList.add('btn-primary');
            console.log('‚úÖ Button reset via alternative method');
        }
    }
    
    console.log('‚úÖ Hide complete - you can reveal again now!');
    
    // Final check and alert
    setTimeout(() => {
        const finalBtn = document.getElementById('reveal-btn') || document.querySelector('.reveal-hide-btn');
        if (finalBtn) {
            console.log('‚úÖ Final check - Reveal button exists and ready');
            console.log('Button text:', finalBtn.innerText);
            console.log('Button visible:', finalBtn.offsetParent !== null);
        } else {
            console.error('‚ùå Reveal button not found after hide!');
            console.error('Reloading page to restore button...');
            // Reload the page to restore the button
            location.reload();
        }
    }, 600);
}

// Matrix-style decryption effect
function createMatrixEffect() {
    const content = document.getElementById('decrypted-content');
    const overlay = document.createElement('div');
    overlay.className = 'matrix-overlay';
    overlay.innerHTML = '<div class="matrix-text">DECRYPTING...</div>';
    content.prepend(overlay);
    
    setTimeout(() => {
        overlay.classList.add('fade-out');
        setTimeout(() => overlay.remove(), 500);
    }, 1000);
}
</script>

<style>
.attachment-image {
    transition: transform 0.2s ease-in-out;
    background: #f8f9fa;
}

.attachment-image:hover {
    transform: scale(1.05);
}

.image-attachments .card {
    border: 1px solid #dee2e6;
    transition: box-shadow 0.2s ease-in-out;
}

.image-attachments .card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* HTML Email Body Styling */
.email-html-body {
    padding: 20px;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    overflow-x: auto;
}

.email-html-body .email-html-content {
    max-width: 100%;
}

.email-html-body img {
    max-width: 100%;
    height: auto;
}

.email-html-body table {
    max-width: 100%;
    border-collapse: collapse;
}

.email-html-body a {
    color: #0066cc;
    text-decoration: underline;
}

/* Encrypted Message Reveal Animations */
.encrypted-message-container {
    position: relative;
}

#encrypted-banner {
    transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

#reveal-btn {
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

#reveal-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(13, 110, 253, 0.4);
}

/* Unlock animation for lock icon */
@keyframes unlock {
    0% {
        transform: rotate(0deg) scale(1);
    }
    25% {
        transform: rotate(-10deg) scale(1.2);
    }
    50% {
        transform: rotate(10deg) scale(1.2);
    }
    75% {
        transform: rotate(-5deg) scale(1.1);
    }
    100% {
        transform: rotate(0deg) scale(1);
    }
}

.unlock-animation {
    animation: unlock 0.6s ease-in-out;
}

/* Reveal content animation */
@keyframes revealSlide {
    0% {
        opacity: 0;
        transform: translateY(-20px);
        filter: blur(10px);
    }
    100% {
        opacity: 1;
        transform: translateY(0);
        filter: blur(0);
    }
}

.reveal-animation {
    animation: revealSlide 0.8s ease-out;
}

@keyframes hideSlide {
    0% {
        opacity: 1;
        transform: translateY(0);
    }
    100% {
        opacity: 0;
        transform: translateY(-20px);
    }
}

.hide-animation {
    animation: hideSlide 0.5s ease-in;
}

/* Decrypt success animation */
@keyframes successPulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.02);
    }
}

.decrypt-success-animation {
    animation: successPulse 0.6s ease-in-out;
}

/* Message reveal cascade */
@keyframes messageReveal {
    0% {
        opacity: 0;
        transform: translateY(10px);
        filter: blur(5px);
    }
    100% {
        opacity: 1;
        transform: translateY(0);
        filter: blur(0);
    }
}

.message-reveal-animation {
    animation: messageReveal 1s ease-out 0.3s both;
}

/* Matrix-style overlay */
.matrix-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(0, 255, 0, 0.1) 0%, rgba(0, 200, 0, 0.1) 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    animation: matrixFade 1s ease-out;
    backdrop-filter: blur(2px);
}

@keyframes matrixFade {
    0% {
        opacity: 0;
    }
    50% {
        opacity: 1;
    }
    100% {
        opacity: 1;
    }
}

.matrix-overlay.fade-out {
    animation: fadeOut 0.5s ease-out forwards;
}

@keyframes fadeOut {
    to {
        opacity: 0;
    }
}

.matrix-text {
    font-family: 'Courier New', monospace;
    font-size: 24px;
    font-weight: bold;
    color: #00ff00;
    text-shadow: 0 0 10px #00ff00, 0 0 20px #00ff00, 0 0 30px #00ff00;
    animation: matrixBlink 0.5s infinite;
}

@keyframes matrixBlink {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.5;
    }
}

/* Glow effect on button */
@keyframes buttonGlow {
    0%, 100% {
        box-shadow: 0 0 5px rgba(13, 110, 253, 0.5);
    }
    50% {
        box-shadow: 0 0 20px rgba(13, 110, 253, 0.8);
    }
}

#reveal-btn:focus {
    animation: buttonGlow 1s ease-in-out infinite;
}

/* Pulse-fade animation for auto-hide */
@keyframes pulse-fade {
    0% {
        opacity: 1;
        transform: scale(1);
    }
    25% {
        opacity: 0.8;
        transform: scale(1.02);
    }
    50% {
        opacity: 0.6;
        transform: scale(1);
    }
    75% {
        opacity: 0.4;
        transform: scale(0.98);
    }
    100% {
        opacity: 0;
        transform: scale(0.95);
    }
}

/* Countdown display styling */
.countdown-display {
    display: inline-block;
    padding: 4px 10px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 15px;
    font-weight: 600;
    animation: countdown-pulse 1s ease-in-out infinite;
}

@keyframes countdown-pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.7;
    }
}

/* Warning flash when time is running out */
.countdown-warning {
    animation: warning-flash 0.5s ease-in-out infinite;
}

@keyframes warning-flash {
    0%, 100% {
        background: rgba(255, 193, 7, 0.3);
    }
    50% {
        background: rgba(220, 53, 69, 0.3);
    }
}

/* Enhanced Reveal/Hide Button Animations */
.reveal-hide-btn {
    position: relative;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    min-width: 140px;
}

.reveal-hide-btn .btn-icon {
    display: inline-block;
    transition: transform 0.3s ease;
}

.reveal-hide-btn .btn-text {
    display: inline-block;
    margin-left: 5px;
    transition: opacity 0.3s ease;
}

.reveal-hide-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.reveal-hide-btn:active {
    transform: scale(0.95);
}

/* Button transformation animation */
.btn-transforming {
    animation: button-morph 0.3s ease-in-out;
}

@keyframes button-morph {
    0% {
        transform: scale(1) rotate(0deg);
    }
    50% {
        transform: scale(0.8) rotate(180deg);
        opacity: 0.5;
    }
    100% {
        transform: scale(1) rotate(360deg);
    }
}

.btn-transformed {
    animation: button-pulse 0.5s ease-in-out;
}

@keyframes button-pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.1);
    }
}

/* Floating Hide Button */
.floating-hide-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    border: none;
    box-shadow: 0 4px 20px rgba(245, 87, 108, 0.4);
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    z-index: 1000;
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    opacity: 0;
    transform: scale(0) rotate(-180deg);
}

.floating-hide-btn.show {
    opacity: 1;
    transform: scale(1) rotate(0deg);
}

.floating-hide-btn:hover {
    transform: scale(1.15) rotate(10deg);
    box-shadow: 0 6px 30px rgba(245, 87, 108, 0.6);
}

.floating-hide-btn:active {
    transform: scale(0.9) rotate(-10deg);
}

.floating-hide-btn .tooltip-text {
    position: absolute;
    right: 70px;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 8px 12px;
    border-radius: 5px;
    font-size: 14px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
}

.floating-hide-btn:hover .tooltip-text {
    opacity: 1;
}

/* Floating button animation */
@keyframes float-bounce {
    0%, 100% {
        transform: scale(1) rotate(0deg) translateY(0);
    }
    50% {
        transform: scale(1) rotate(0deg) translateY(-10px);
    }
}

.floating-hide-btn.show {
    opacity: 1;
    transform: scale(1) rotate(0deg);
    animation: float-bounce 2s ease-in-out infinite;
}

/* Button ripple effect */
.reveal-hide-btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.5);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
}

.reveal-hide-btn:active::before {
    width: 300px;
    height: 300px;
}

/* Icon rotation on hover */
.reveal-hide-btn:hover .btn-icon i {
    animation: icon-wiggle 0.5s ease-in-out;
}

@keyframes icon-wiggle {
    0%, 100% {
        transform: rotate(0deg);
    }
    25% {
        transform: rotate(-10deg);
    }
    75% {
        transform: rotate(10deg);
    }
}

/* Mobile responsive */
@media (max-width: 768px) {
    .floating-hide-btn {
        bottom: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        font-size: 18px;
    }
    
    .floating-hide-btn .tooltip-text {
        display: none;
    }
}

/* Hide Content Button Styles */
.hide-content-btn {
    transition: all 0.3s ease;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
}

.hide-content-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(220, 53, 69, 0.5);
}

.hide-content-btn:active {
    transform: scale(0.95);
}

.hide-content-btn i {
    margin-right: 5px;
}
</style>

<script>
// Toggle star status
function toggleStar(emailId) {
    fetch(`/email/action/${emailId}/toggle_star`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const btn = document.getElementById('star-btn');
            if (data.is_starred) {
                btn.classList.add('active');
                btn.innerHTML = '<i class="fas fa-star"></i> Starred';
                showToast('Email starred!', 'success');
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '<i class="fas fa-star"></i> Star';
                showToast('Star removed', 'info');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to update star status. Please try again.', 'error');
    });
}

// Toggle important status
function toggleImportant(emailId) {
    fetch(`/email/action/${emailId}/toggle_important`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const btn = document.getElementById('important-btn');
            if (data.is_important) {
                btn.classList.add('active');
                btn.innerHTML = '<i class="fas fa-exclamation-circle"></i> Important';
                showToast('Marked as important!', 'success');
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '<i class="fas fa-exclamation-circle"></i> Mark Important';
                showToast('Removed from important', 'info');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to update important status. Please try again.', 'error');
    });
}

// Mark as spam
function markAsSpam(emailId) {
    if (confirm('Mark this email as spam? Similar emails will be automatically filtered.')) {
        fetch(`/email/action/${emailId}/mark_spam`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showToast('Email marked as spam. Redirecting...', 'success');
                setTimeout(() => {
                    window.location.href = '/email/inbox';
                }, 1500);
            } else {
                showToast(data.error || 'Failed to mark as spam', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Failed to mark as spam. Please try again.', 'error');
        });
    }
}

// Not spam
function notSpam(emailId) {
    fetch(`/email/action/${emailId}/not_spam`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast('Email moved to inbox. Redirecting...', 'success');
            setTimeout(() => {
                window.location.href = '/email/inbox';
            }, 1500);
        } else {
            showToast(data.error || 'Failed to move email', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to move email. Please try again.', 'error');
    });
}

// Show toast notification
function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} toast-notification`;
    toast.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 250px; animation: slideIn 0.3s ease;';
    toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
        ${message}
    `;
    
    document.body.appendChild(toast);
    
    // Remove after 3 seconds
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Add CSS for toast animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(400px);
            opacity: 0;
        }
    }
    
    .toast-notification {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
`;
document.head.appendChild(style);
</script>

{% endblock %}
